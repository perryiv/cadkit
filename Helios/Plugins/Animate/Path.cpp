
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2007, Arizona State University
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//  Author: Adam Kubach
//
///////////////////////////////////////////////////////////////////////////////

#include "Helios/Plugins/Animate/Path.h"

#include "Usul/Math/Transpose.h"
#include "Usul/Errors/Assert.h"
#include "Usul/Interfaces/IFrameStamp.h"
#include "Usul/Interfaces/IViewMatrix.h"
#include "Usul/Factory/RegisterCreator.h"

#include "osg/FrameStamp"

using namespace Animate;

USUL_IMPLEMENT_IUNKNOWN_MEMBERS ( Path, Path::BaseClass );
//USUL_FACTORY_REGISTER_CREATOR_WITH_NAME ( "MatrixPath", Path );

///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Path::Path () : 
  BaseClass (),
  _dirty ( false ),
  _acceptNewFrames ( false ),
  _startTime ( -1.0 ),
  _animating( false )
{
}


///////////////////////////////////////////////////////////////////////////////
//
//  Destructor.
//
///////////////////////////////////////////////////////////////////////////////

Path::~Path ()
{
}


///////////////////////////////////////////////////////////////////////////////
//
//  Set the dirty flag.
//
///////////////////////////////////////////////////////////////////////////////

void Path::dirty ( bool b )
{
  Guard guard ( this->mutex () );
  _dirty = b;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the dirty flag.
//
///////////////////////////////////////////////////////////////////////////////

bool Path::dirty () const
{
  Guard guard ( this->mutex () );
  return _dirty;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Start the animation from beginning.
//
///////////////////////////////////////////////////////////////////////////////

void Path::start ( Usul::Interfaces::IUnknown * caller )
{
  Usul::Interfaces::IFrameStamp::QueryPtr fs ( caller );
  if ( fs.valid() )
  {
    Guard guard ( this->mutex () );
    _startTime = fs->frameStamp ()->getReferenceTime ();
  }

  {
    Guard guard ( this->mutex () );
    _animating = true;
  }
}


///////////////////////////////////////////////////////////////////////////////
//
//  Are we animating?
//
///////////////////////////////////////////////////////////////////////////////

bool Path::animating () const
{
  Guard guard ( this->mutex () );
  return _animating;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Set flag to accept new frames.
//
///////////////////////////////////////////////////////////////////////////////

void Path::acceptNewFrames ( bool b )
{
  Guard guard ( this->mutex () );
  _acceptNewFrames = b;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Set flag to accept new frames.
//
///////////////////////////////////////////////////////////////////////////////

bool Path::acceptNewFrames () const
{
  Guard guard ( this->mutex () );
  return _acceptNewFrames;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Append a frame.
//
///////////////////////////////////////////////////////////////////////////////

void Path::append ( Frame* frame )
{
  if ( this->acceptNewFrames () )
    this->_append ( frame );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Query for interface.
//
///////////////////////////////////////////////////////////////////////////////

Usul::Interfaces::IUnknown* Path::queryInterface ( unsigned long iid )
{
  switch ( iid )
  {
  case Usul::Interfaces::IUnknown::IID:
  case Usul::Interfaces::IUpdateListener::IID:
    return static_cast < Usul::Interfaces::IUpdateListener * > ( this );
  default:
    return 0x0;
  }
}


///////////////////////////////////////////////////////////////////////////////
//
//  Update.
//
///////////////////////////////////////////////////////////////////////////////

void Path::updateNotify ( Usul::Interfaces::IUnknown *caller )
{
}
