
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2002, Perry L. Miller IV
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
//
//  The frustum culling class.
//
///////////////////////////////////////////////////////////////////////////////

#include "GSG/Core/Precompiled.h"
#include "GSG/Core/FrustumCull.h"
#include "GSG/Core/Transform.h"
#include "GSG/Core/Lod.h"
#include "GSG/Core/Camera.h"
#include "GSG/Core/Shape.h"

using namespace GSG;

GSG_IMPLEMENT_REFERENCED ( FrustumCull );


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

FrustumCull::FrustumCull ( RenderBin *bin ) : BinBuilder ( bin )
{
  // Empty.
}


///////////////////////////////////////////////////////////////////////////////
//
//  Copy constructor.
//
///////////////////////////////////////////////////////////////////////////////

FrustumCull::FrustumCull ( const FrustumCull &c ) : BinBuilder ( c )
{
  // Empty.
}


///////////////////////////////////////////////////////////////////////////////
//
//  Destructor.
//
///////////////////////////////////////////////////////////////////////////////

FrustumCull::~FrustumCull()
{
  // Empty.
}


///////////////////////////////////////////////////////////////////////////////
//
//  The visit functions.
//
///////////////////////////////////////////////////////////////////////////////

GSG_DEFINE_DELEGATING_VISIT_NODE_FUNCTIONS ( FrustumCull, _cull );


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the node.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( Node &n )
{
  // Should never be here.
  ErrorChecker ( false );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the shape.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( Shape &s )
{
  // Loop through the primitive-sets.
  for ( Shape::iterator i = s.begin(); i != s.end(); ++i )
    this->_cull ( **i );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the primitive-set.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( PrimitiveSet &ps )
{
  ErrorChecker ( 0x0 != this->renderBin() );

  // Insert the elements into the bin.
  this->renderBin()->add ( new PrimitiveSetElement ( &ps ) );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the group.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( Group &g )
{
  // Traverse the group.
  this->_traverse ( g );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the transform.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( Transform &t )
{
  ErrorChecker ( 0x0 != this->renderBin() );

  // Insert the elements into the bin.
  this->renderBin()->add ( new MatrixModeElement ( MatrixModeElement::MODELVIEW ) );
  this->renderBin()->add ( new MatrixLoadElement ( t.matrix() ) );

  // Delegate.
  this->_cull ( (Transform::BaseClass &) t );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Cull the camera.
//
///////////////////////////////////////////////////////////////////////////////

void FrustumCull::_cull ( Camera &c )
{
  ErrorChecker ( 0x0 != this->renderBin() );

  // Insert the elements into the bin.
  this->renderBin()->add ( new MatrixModeElement ( MatrixModeElement::PROJECTION ) );
  this->renderBin()->add ( new MatrixLoadElement ( c.projection() ) );
  this->renderBin()->add ( new MatrixModeElement ( MatrixModeElement::MODELVIEW ) );
  this->renderBin()->add ( new MatrixLoadElement ( c.modelview() ) );

  // Delegate.
  this->_cull ( (Camera::BaseClass &) c );
}


/////////////////////////////////////////////////////////////////////////////
//
//  Set from the given object.
//
/////////////////////////////////////////////////////////////////////////////

void FrustumCull::setFrom ( const FrustumCull &f )
{
  // Call the base class's function.
  BaseClass::setFrom ( f );
}
