
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2008, Arizona State University
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//  Author(s): Jeff Conner
//
///////////////////////////////////////////////////////////////////////////////

#include "OsgTools/Points/PointSet.h"
#include "OsgTools/Configure/OSG.h"

#include "osgDB/WriteFile"

#include "osg/BoundingBox"

#include <iostream>

//USUL_IMPLEMENT_IUNKNOWN_MEMBERS ( PointSet, PointSet::BaseClass );

using namespace OsgTools::Points;
USUL_IMPLEMENT_TYPE_ID ( PointSet );

///////////////////////////////////////////////////////////////////////////////
//
//  Constructor
//
///////////////////////////////////////////////////////////////////////////////

PointSet::PointSet() : BaseClass (),
_points( new osg::Vec3Array ),
_tree( new OctTree() )
{
  // Remove this after testing
#if 0
  osg::BoundingBox bb ( 1352000.0f, -70900.0f, 4300.0f, 1355000.0f, -70000.0f, 4900.0f );
  _tree->bounds( bb );
#endif
}


///////////////////////////////////////////////////////////////////////////////
//
//  Destructor
//
///////////////////////////////////////////////////////////////////////////////

PointSet::~PointSet()
{
 
}


///////////////////////////////////////////////////////////////////////////////
//
//  Clear the document.
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::clear ( Unknown *caller )
{
  Guard guard ( this->mutex() );
  _points->clear();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Build the scene.
//
///////////////////////////////////////////////////////////////////////////////

osg::Node *PointSet::buildScene ( Unknown *caller )
{
  Guard guard ( this->mutex() );
  GroupPtr group ( new osg::Group );
  group->addChild( _tree->buildScene( caller ) );
  return group.release();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Build the vector of points from the linked list
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::buildVectors()
{
  Guard guard ( this->mutex() );
  _tree->buildVectors();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Add a point
//
///////////////////////////////////////////////////////////////////////////////

bool PointSet::addPoint( float x, float y, float z )
{
  Guard guard ( this );
  osg::Vec3d p ( static_cast< double > ( x ), static_cast< double > ( y ), static_cast< double > ( z ) );
  return this->addPoint( p );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Add a point
//
///////////////////////////////////////////////////////////////////////////////

bool PointSet::addPoint( double x, double y, double z )
{
  Guard guard ( this );
  return this->addPoint( osg::Vec3d ( x, y, z ) );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Add a point
//
///////////////////////////////////////////////////////////////////////////////

bool PointSet::addPoint( osg::Vec3 p )
{
  Guard guard ( this );
  osg::Vec3d point ( static_cast< double > ( p.x() ), static_cast< double > ( p.y() ), static_cast< double > ( p.z() ) );
  
#if 1 // With spatial partitioning
  return _tree->insert( point );
#else // NO spatial partitioning
  _points->push_back( point );
#endif

  
}


///////////////////////////////////////////////////////////////////////////////
//
//  Allocate space for this point set
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::allocate( unsigned int num )
{
  Guard guard ( this );
  _points->reserve( num );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Set the bounds of the data
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::bounds( osg::Vec3f min, osg::Vec3f max )
{
  Guard guard ( this );
  osg::BoundingBox bb ( min.x(), min.y(), min.z(), max.x(), max.y(), max.z() );
  _tree->bounds( bb );

}


///////////////////////////////////////////////////////////////////////////////
//
//  Set the capacity level for the octree
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::capacity( unsigned int t )
{
  Guard guard ( this );
  _tree->capacity( t );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Create the octree
//
///////////////////////////////////////////////////////////////////////////////

void PointSet::split()
{
  Guard guard ( this );
  _tree->split();
}

