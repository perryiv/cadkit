
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2002, Perry L Miller IV
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
//
//  Base class for all objects.
//
///////////////////////////////////////////////////////////////////////////////

#include "AppFrameWork/Core/Object.h"
#include "AppFrameWork/Core/Define.h"

#include "Usul/Errors/Assert.h"
#include "Usul/MPL/SameType.h"

#include <iostream>
#include <stdexcept>

using namespace AFW::Core;


///////////////////////////////////////////////////////////////////////////////
//
//  Static data member(s).
//
///////////////////////////////////////////////////////////////////////////////

Object::ObjectList Object::_allObjects;


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Object::Object() : BaseClass(),
  _whichObject ( _allObjects.end() ),
  _userData    ()
{
  typedef std::list < Object::ValidRefPtr > ListOfObjects;
  typedef std::iterator_traits < Object::ObjectList::iterator > Traits1;
  typedef std::iterator_traits < ListOfObjects::iterator > Traits2;
  typedef Traits1::iterator_category Category1;
  typedef Traits2::iterator_category Category2;
  USUL_ASSERT_SAME_TYPE ( Category1, Category2 );

  // Relies on the fact that list iterators are not invalidated.
  _whichObject = _allObjects.insert ( _allObjects.end(), this );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Destructor.
//
///////////////////////////////////////////////////////////////////////////////

Object::~Object()
{
  // Safely...
  try
  {
    USUL_ASSERT ( false == _allObjects.empty() );

    // Relies on the fact that list iterators are not invalidated.
    _allObjects.erase ( _whichObject );
  }

  // Catch exceptions.
  AFW_CATCH_BLOCK ( "1072220024", "2486162374" );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the user-data.
//
///////////////////////////////////////////////////////////////////////////////

const Object::UserData *Object::userData() const
{
  return _userData.get();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the user-data.
//
///////////////////////////////////////////////////////////////////////////////

Object::UserData *Object::userData()
{
  return _userData.get();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Set the user-data.
//
///////////////////////////////////////////////////////////////////////////////

void Object::userData ( UserData *data )
{
  _userData = data;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Iterator to the list of all objects.
//
///////////////////////////////////////////////////////////////////////////////

Object::ObjectListItr Object::allObjectsBegin()
{
  return _allObjects.begin();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Iterator to the list of all objects.
//
///////////////////////////////////////////////////////////////////////////////

Object::ObjectListItr Object::allObjectsEnd()
{
  return _allObjects.end();
}
