
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2007, Adam Kubach
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
//
//  Date class wrapper around boost's date class.
//
///////////////////////////////////////////////////////////////////////////////

#include "OsgTools/Animate/Date.h"

#include "Usul/Strings/Split.h"

#include <vector>
#include <sstream>

using namespace OsgTools::Animate;

///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Date::Date() :
_date()
{
  USUL_TRACE_SCOPE;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Date::Date( const std::string& date ) :
_date ( boost::gregorian::from_simple_string ( date ) )
{
  USUL_TRACE_SCOPE;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Date::Date ( boost::date_time::special_values value ) : _date ( value )
{
  USUL_TRACE_SCOPE;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

Date::Date ( const boost::gregorian::date& date ) : _date ( date )
{
  USUL_TRACE_SCOPE;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return the day.
//
///////////////////////////////////////////////////////////////////////////////

unsigned int Date::day() const
{
  return _date.day();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return the month.
//
///////////////////////////////////////////////////////////////////////////////

unsigned int Date::month() const
{
  return _date.month();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return the year.
//
///////////////////////////////////////////////////////////////////////////////

unsigned int Date::year() const
{
  return _date.year();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Increment the day.
//
///////////////////////////////////////////////////////////////////////////////

void Date::increment()
{
  boost::gregorian::date_duration dd(1);
  _date = _date + dd;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return the date as a string.
//
///////////////////////////////////////////////////////////////////////////////

std::string Date::toString() const
{
  return boost::gregorian::to_simple_string(_date);
}


///////////////////////////////////////////////////////////////////////////////
//
//  construct the date from a string.
//
///////////////////////////////////////////////////////////////////////////////

void Date::fromString( const std::string& date )
{
  USUL_TRACE_SCOPE;
  USUL_TRACE_1 ( date );

  std::vector< std::string > split;

  Usul::Strings::split ( date, '-', false, split );

  if( 3 == split.size() )
  {
    unsigned int year ( 0 ), month ( 0 ), day ( 0 );

    {
      std::istringstream in ( split[0] );
      in >> year;
    }

    {
      typedef boost::gregorian::greg_month Month;
      typedef Month::month_map_type MonthMap;
      typedef MonthMap::iterator MonthIterator;
      MonthIterator iter = Month::get_month_map_ptr()->find( split[1] );
      if( iter != Month::get_month_map_ptr()->end() )
      {
	month = iter->second;
      }
    }

    {
      std::istringstream in ( split[0] );
      in >> day;
    }

    split.clear();

    //    _date = boost::gregorian::from_simple_string ( date );
    _date = boost::gregorian::date ( year, month, day );
  }
}


///////////////////////////////////////////////////////////////////////////////
//
//  Is the given date less than this date?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator<( const Date& rhs ) const
{
  return this->_toJulian() < rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Is the given date greater than this date?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator>( const Date& rhs ) const
{
  return this->_toJulian() > rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Are the two dates equal?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator==( const Date& rhs ) const
{
  return this->_toJulian() == rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Are the two dates different?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator!=(const Date& rhs ) const
{
  return this->_toJulian() != rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Move the date back the given number of days.
//
///////////////////////////////////////////////////////////////////////////////

void Date::moveBackNumDays ( unsigned int days )
{
  _date = _date - boost::gregorian::date_duration( days );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Is the given date the same or before this date?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator<=( const Date& rhs ) const
{
  return this->_toJulian() <= rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Is the given date the same or after this date?
//
///////////////////////////////////////////////////////////////////////////////

bool Date::operator>=( const Date& rhs ) const
{
  return this->_toJulian() >= rhs._toJulian();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get this date's Julian day value.
//
///////////////////////////////////////////////////////////////////////////////

long Date::_toJulian() const
{
  return _date.julian_day();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the underlying boost date.
//
///////////////////////////////////////////////////////////////////////////////

boost::gregorian::date& Date::date()
{
  return _date;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the underlying boost date.
//
///////////////////////////////////////////////////////////////////////////////

const boost::gregorian::date& Date::date() const
{
  return _date;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Increment the day by one.
//
///////////////////////////////////////////////////////////////////////////////

void Date::incrementDay()
{
  boost::gregorian::date_duration dd(1);
  _date = _date + dd;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Increment the month by one.
//
///////////////////////////////////////////////////////////////////////////////

void Date::incrementMonth()
{
  boost::gregorian::months one(1);
  _date = _date + one;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Increment the year by one.
//
///////////////////////////////////////////////////////////////////////////////

void Date::incrementYear()
{
  boost::gregorian::years one(1);
  _date = _date + one;
}
