
///////////////////////////////////////////////////////////////////////////////
//
//  Copyright (c) 2004, Perry L Miller IV
//  All rights reserved.
//  BSD License: http://www.opensource.org/licenses/bsd-license.html
//
///////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
//
//  The camera path class.
//
///////////////////////////////////////////////////////////////////////////////

#include "PathAnimation/CameraPath.h"
#include "Serialize/XML/Deserialize.h"
#include "Serialize/XML/Serialize.h"

#include "Usul/Factory/RegisterCreator.h"
#include "Usul/File/Path.h"
#include "Usul/Strings/Case.h"
#include "Usul/Trace/Trace.h"

USUL_FACTORY_REGISTER_CREATOR ( CameraPath );

USUL_IO_TEXT_DEFINE_READER_TYPE_VECTOR_3 ( CameraPath::Triplet );
USUL_IO_TEXT_DEFINE_WRITER_TYPE_VECTOR_3 ( CameraPath::Triplet );
SERIALIZE_XML_DECLARE_VECTOR_3_WRAPPER ( CameraPath::Triplet );


///////////////////////////////////////////////////////////////////////////////
//
//  Constructor.
//
///////////////////////////////////////////////////////////////////////////////

CameraPath::CameraPath() : BaseClass ( "Camera Path Document" ),
  _values()
{
  USUL_TRACE_SCOPE;

  this->_addMember ( "values", _values );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Destructor.
//
///////////////////////////////////////////////////////////////////////////////

CameraPath::~CameraPath()
{
  USUL_TRACE_SCOPE;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the camera info.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::camera ( Usul::Math::Vec3d &eye, Usul::Math::Vec3d &center, Usul::Math::Vec3d &up, unsigned int num ) const
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  if ( num < this->size() )
  {
    Triplet t ( _values.at ( num ) );
    eye = t[0];
    center = t[1];
    up = t[2];
  }
}


///////////////////////////////////////////////////////////////////////////////
//
//  Append the camera information.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::cameraAppend ( const Usul::Math::Vec3d &eye, const Usul::Math::Vec3d &center, const Usul::Math::Vec3d &up )
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  _values.insert ( _values.end(), Triplet ( eye, center, up ) );
  this->modified ( true );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Prepend the camera information.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::cameraPrepend ( const Usul::Math::Vec3d &eye, const Usul::Math::Vec3d &center, const Usul::Math::Vec3d &up )
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  _values.insert ( _values.begin(), Triplet ( eye, center, up ) );
  this->modified ( true );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Close the path if we can.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::closePath()
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );

  if ( false == this->canClose() )
    return;

  _values.insert ( _values.end(), _values.front() );
  this->modified ( true );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Can we close the path?
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canClose() const
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  return ( _values.size() > 1 );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Can we play the animation?
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canPlay() const
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  return ( _values.size() > 1 );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return true if this document can do it.
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canExport ( const std::string &file ) const
{
  return this->canSave ( file );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return true if this document can do it.
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canInsert ( const std::string &file ) const
{
  return this->canSave ( file );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return true if this document can do it.
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canOpen ( const std::string &file ) const
{
  return this->canSave ( file );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return true if this document can do it.
//
///////////////////////////////////////////////////////////////////////////////

bool CameraPath::canSave ( const std::string &file ) const
{
  const std::string ext ( Usul::Strings::lowerCase ( Usul::File::extension ( file ) ) );
  return ( ext == "cpf" );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the filters that correspond to what this document can export.
//
///////////////////////////////////////////////////////////////////////////////

CameraPath::Filters CameraPath::filtersExport() const
{
  return this->filtersSave();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the filters that correspond to what this document can insert.
//
///////////////////////////////////////////////////////////////////////////////

CameraPath::Filters CameraPath::filtersInsert() const
{
  return this->filtersSave();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the filters that correspond to what this document can open.
//
//////////////////////////////////////////////////////////////////////////////

CameraPath::Filters CameraPath::filtersOpen() const
{
  return this->filtersSave();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the filters that correspond to what this document can save.
//
///////////////////////////////////////////////////////////////////////////////

CameraPath::Filters CameraPath::filtersSave() const
{
  Filters filters;
  filters.push_back ( Filter ( "Camera Path (*.cpf)", "*.cpf" ) );
  return filters;
}


///////////////////////////////////////////////////////////////////////////////
//
//  Read.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::read ( const std::string &file, Unknown *caller, Unknown *progress )
{
  XmlTree::XercesLife life;
  XmlTree::Document::ValidRefPtr document ( new XmlTree::Document );
  document->load ( file );
  this->deserialize ( *document );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Write.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::write ( const std::string &file, Unknown *caller, Unknown *progress  ) const
{
  Serialize::XML::serialize ( *this, file );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Clear all the paths.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::clear ( Usul::Interfaces::IUnknown *caller )
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  _values.clear();
  this->modified ( true );
}


///////////////////////////////////////////////////////////////////////////////
//
//  Return the number of cameras.
//
///////////////////////////////////////////////////////////////////////////////

unsigned int CameraPath::size() const
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );
  return _values.size();
}


///////////////////////////////////////////////////////////////////////////////
//
//  Get the values.
//
///////////////////////////////////////////////////////////////////////////////

void CameraPath::values ( Values &v, bool reverseOrder ) const
{
  USUL_TRACE_SCOPE;
  Guard guard ( this );

  if ( true == reverseOrder )
  {
    v.assign ( _values.rbegin(), _values.rend() );
  }
  else
  {
    v.assign ( _values.begin(), _values.end() );
  }
}
